using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Design;
using Microsoft.Extensions.Configuration;

namespace Infrastructure.Persistence;

/// <summary>
/// Design-time factory for EF Core migrations.
/// Reads connection string from appsettings.json + appsettings.Development.json in the Api project.
/// </summary>
public sealed class ApplicationDbContextFactory : IDesignTimeDbContextFactory<ApplicationDbContext>
{
    public ApplicationDbContext CreateDbContext(string[] args)
    {
        var apiDir = FindApiDirectory();

        Console.WriteLine($"[EF Design-Time] Using Api directory: {apiDir}");

        var configBuilder = new ConfigurationBuilder()
            .SetBasePath(apiDir)
            .AddJsonFile("appsettings.json", optional: true, reloadOnChange: false);

        // Add Development config if it exists (contains real connection string)
        var devSettingsPath = Path.Combine(apiDir, "appsettings.Development.json");
        if (File.Exists(devSettingsPath))
        {
            configBuilder.AddJsonFile("appsettings.Development.json", optional: true, reloadOnChange: false);
            Console.WriteLine("[EF Design-Time] Loaded appsettings.Development.json");
        }
        else
        {
            Console.WriteLine("[EF Design-Time] WARNING: appsettings.Development.json not found");
        }

        var configuration = configBuilder.Build();
        var connectionString = configuration.GetConnectionString("DefaultConnection");

        if (string.IsNullOrWhiteSpace(connectionString) || connectionString.Contains("__"))
        {
            throw new InvalidOperationException(
                "Connection string 'DefaultConnection' not found or contains placeholders. " +
                "Ensure appsettings.Development.json exists with a valid connection string.");
        }

        Console.WriteLine($"[EF Design-Time] Connection string found (length: {connectionString.Length})");

        var optionsBuilder = new DbContextOptionsBuilder<ApplicationDbContext>()
            .UseSqlServer(connectionString);

        return new ApplicationDbContext(optionsBuilder.Options);
    }

    private static string FindApiDirectory()
    {
        var candidates = new List<string>();

        var currentDir = Directory.GetCurrentDirectory();
        candidates.Add(currentDir);
        candidates.Add(Path.Combine(currentDir, "Api"));
        candidates.Add(Path.Combine(currentDir, "..", "Api"));

        // Walk up from current directory looking for Api folder
        var dir = new DirectoryInfo(currentDir);
        while (dir != null)
        {
            var apiPath = Path.Combine(dir.FullName, "Api");
            if (Directory.Exists(apiPath))
                candidates.Add(apiPath);
            dir = dir.Parent;
        }

        foreach (var path in candidates.Distinct(StringComparer.OrdinalIgnoreCase))
        {
            if (!Directory.Exists(path)) continue;

            var appsettings = Path.Combine(path, "appsettings.json");
            if (File.Exists(appsettings))
            {
                return path;
            }
        }

        throw new DirectoryNotFoundException(
            $"Api directory with appsettings.json not found. Searched: {string.Join(", ", candidates)}");
    }
}
