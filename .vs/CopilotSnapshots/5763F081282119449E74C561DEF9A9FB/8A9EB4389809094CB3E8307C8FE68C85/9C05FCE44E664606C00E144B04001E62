using Application.Auth.Commands;
using Application.Auth.Dtos;
using Application.Common.Interfaces;
using Domain.Entities;
using MediatR;
using Microsoft.AspNetCore.Identity;
using Microsoft.Extensions.Logging;
using System.Security.Cryptography;
using System.Text;

namespace Application.Auth.Handlers;

public sealed class ForgotPasswordCommandHandler : IRequestHandler<ForgotPasswordCommand, ForgotPasswordResponse>
{
    private readonly UserManager<AppUser> _userManager;
    private readonly IPasswordResetCodeRepository _resetCodeRepository;
    private readonly IEmailSender _emailSender;
    private readonly ILogger<ForgotPasswordCommandHandler> _logger;

    private const int CodeExpirationMinutes = 10;
    private const int MinSecondsBetweenRequests = 60;
    private const int MaxAttempts = 5;

    public ForgotPasswordCommandHandler(
        UserManager<AppUser> userManager,
        IPasswordResetCodeRepository resetCodeRepository,
        IEmailSender emailSender,
        ILogger<ForgotPasswordCommandHandler> logger)
    {
        _userManager = userManager;
        _resetCodeRepository = resetCodeRepository;
        _emailSender = emailSender;
        _logger = logger;
    }

    public async Task<ForgotPasswordResponse> Handle(ForgotPasswordCommand command, CancellationToken cancellationToken)
    {
        var email = command.Request.Email.Trim().ToLowerInvariant();
        var genericMessage = "If the email exists, a password reset code has been sent.";

        _logger.LogDebug("Processing forgot password request for email: {Email}", email);

        var user = await _userManager.FindByEmailAsync(email);
        if (user is null)
        {
            _logger.LogDebug("User not found for email: {Email}, returning generic response", email);
            return new ForgotPasswordResponse(genericMessage);
        }

        var existingCode = await _resetCodeRepository.GetActiveByUserIdAsync(user.Id, cancellationToken);
        if (existingCode is not null && existingCode.LastSentAtUtc.HasValue)
        {
            var secondsSinceLastSent = (DateTime.UtcNow - existingCode.LastSentAtUtc.Value).TotalSeconds;
            if (secondsSinceLastSent < MinSecondsBetweenRequests)
            {
                _logger.LogWarning("Rate limit hit for user {UserId}, last sent {Seconds}s ago", user.Id, secondsSinceLastSent);
                return new ForgotPasswordResponse(genericMessage);
            }
        }

        var code = GenerateCode();
        var codeHash = HashCode(code);

        await _resetCodeRepository.InvalidateAllForUserAsync(user.Id, cancellationToken);

        var resetCode = new PasswordResetCode
        {
            UserId = user.Id,
            CodeHash = codeHash,
            ExpiresAtUtc = DateTime.UtcNow.AddMinutes(CodeExpirationMinutes),
            Attempts = 0,
            LastSentAtUtc = DateTime.UtcNow,
            IsUsed = false,
            CreatedAt = DateTime.UtcNow
        };

        await _resetCodeRepository.AddAsync(resetCode, cancellationToken);
        await _resetCodeRepository.SaveChangesAsync(cancellationToken);

        try
        {
            var subject = "Password Reset Code - LinkedInClone";
            var body = $@"
                <html>
                <body style='font-family: Arial, sans-serif;'>
                    <h2>Password Reset Request</h2>
                    <p>You have requested to reset your password. Use the following code to complete the process:</p>
                    <h1 style='color: #0077B5; letter-spacing: 5px;'>{code}</h1>
                    <p>This code will expire in {CodeExpirationMinutes} minutes.</p>
                    <p>If you did not request this, please ignore this email.</p>
                    <br/>
                    <p>Best regards,<br/>LinkedInClone Team</p>
                </body>
                </html>";

            await _emailSender.SendEmailAsync(email, subject, body, cancellationToken);
            _logger.LogInformation("Password reset code sent to user {UserId}", user.Id);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to send password reset email to user {UserId}", user.Id);
        }

        return new ForgotPasswordResponse(genericMessage);
    }

    private static string GenerateCode()
    {
        return RandomNumberGenerator.GetInt32(100000, 1000000).ToString();
    }

    private static string HashCode(string code)
    {
        var bytes = SHA256.HashData(Encoding.UTF8.GetBytes(code));
        return Convert.ToBase64String(bytes);
    }
}
