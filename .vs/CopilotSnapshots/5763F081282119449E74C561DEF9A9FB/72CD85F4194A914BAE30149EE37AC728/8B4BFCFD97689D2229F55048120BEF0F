using Application.Common.Interfaces;
using Domain.Entities;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;

namespace Infrastructure.Persistence.Services;

public sealed class AccountDeletionService : IAccountDeletionService
{
    private readonly ApplicationDbContext _context;
    private readonly UserManager<AppUser> _userManager;
    private readonly ILogger<AccountDeletionService> _logger;

    public AccountDeletionService(
        ApplicationDbContext context,
        UserManager<AppUser> userManager,
        ILogger<AccountDeletionService> logger)
    {
        _context = context;
        _userManager = userManager;
        _logger = logger;
    }

    public async Task DeleteAccountAsync(Guid userId, CancellationToken cancellationToken = default)
    {
        _logger.LogInformation("Starting account deletion for user {UserId}", userId);

        var strategy = _context.Database.CreateExecutionStrategy();

        await strategy.ExecuteAsync(async () =>
        {
            await using var transaction = await _context.Database.BeginTransactionAsync(cancellationToken);

            try
            {
                _logger.LogDebug("Step 1: Fetching user posts for {UserId}", userId);
                var userPostIds = await _context.Posts
                    .Where(p => p.AuthorId == userId)
                    .Select(p => p.Id)
                    .ToListAsync(cancellationToken);

                _logger.LogDebug("Found {Count} posts for user {UserId}", userPostIds.Count, userId);

                if (userPostIds.Count > 0)
                {
                    _logger.LogDebug("Step 2a: Deleting reactions on user's posts");
                    await _context.Reactions
                        .Where(r => userPostIds.Contains(r.PostId))
                        .ExecuteDeleteAsync(cancellationToken);

                    _logger.LogDebug("Step 2b: Deleting reply comments on user's posts");
                    await _context.Comments
                        .Where(c => userPostIds.Contains(c.PostId) && c.ParentCommentId != null)
                        .ExecuteDeleteAsync(cancellationToken);

                    _logger.LogDebug("Step 2c: Deleting top-level comments on user's posts");
                    await _context.Comments
                        .Where(c => userPostIds.Contains(c.PostId) && c.ParentCommentId == null)
                        .ExecuteDeleteAsync(cancellationToken);

                    _logger.LogDebug("Step 2d: Deleting media on user's posts");
                    await _context.PostMedia
                        .Where(m => userPostIds.Contains(m.PostId))
                        .ExecuteDeleteAsync(cancellationToken);

                    _logger.LogDebug("Step 2e: Deleting user's posts");
                    await _context.Posts
                        .Where(p => p.AuthorId == userId)
                        .ExecuteDeleteAsync(cancellationToken);
                }

                _logger.LogDebug("Step 3: Deleting user's reactions on other posts");
                await _context.Reactions
                    .Where(r => r.UserId == userId)
                    .ExecuteDeleteAsync(cancellationToken);

                _logger.LogDebug("Step 4a: Deleting user's reply comments on other posts");
                await _context.Comments
                    .Where(c => c.AuthorId == userId && c.ParentCommentId != null)
                    .ExecuteDeleteAsync(cancellationToken);

                _logger.LogDebug("Step 4b: Finding user's top-level comments with replies");
                var userTopLevelCommentIds = await _context.Comments
                    .Where(c => c.AuthorId == userId && c.ParentCommentId == null)
                    .Select(c => c.Id)
                    .ToListAsync(cancellationToken);

                if (userTopLevelCommentIds.Count > 0)
                {
                    _logger.LogDebug("Step 4c: Deleting replies to user's top-level comments");
                    await _context.Comments
                        .Where(c => c.ParentCommentId != null && userTopLevelCommentIds.Contains(c.ParentCommentId.Value))
                        .ExecuteDeleteAsync(cancellationToken);
                }

                _logger.LogDebug("Step 4d: Deleting user's top-level comments");
                await _context.Comments
                    .Where(c => c.AuthorId == userId && c.ParentCommentId == null)
                    .ExecuteDeleteAsync(cancellationToken);

                _logger.LogDebug("Step 5: Deleting user profile for {UserId}", userId);
                await _context.UserProfiles
                    .Where(up => up.AppUserId == userId)
                    .ExecuteDeleteAsync(cancellationToken);

                _logger.LogDebug("Step 6: Deleting AppUser via UserManager for {UserId}", userId);
                var user = await _context.Users
                    .FirstOrDefaultAsync(u => u.Id == userId, cancellationToken);

                if (user is not null)
                {
                    _context.Users.Remove(user);
                    await _context.SaveChangesAsync(cancellationToken);
                }

                await transaction.CommitAsync(cancellationToken);
                _logger.LogInformation("Successfully deleted account for user {UserId}", userId);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Failed to delete account for user {UserId}. Rolling back transaction.", userId);
                await transaction.RollbackAsync(cancellationToken);
                throw;
            }
        });
    }
}
